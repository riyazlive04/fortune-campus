// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}



// Models
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  role          String
  isActive      Boolean  @default(true)
  photo         String?
  branchId      String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  branch        Branch?  @relation(fields: [branchId], references: [id], onDelete: SetNull)
  
  // Role-specific relations
  leadsCreated  Lead[]   @relation("LeadCreator")
  leadsAssigned Lead[]   @relation("LeadAssignee")
  studentProfile Student? @relation("StudentUser")
  trainerProfile Trainer?
  incentives    Incentive[]
  notifications Notification[]
  uploadedReports BranchReport[]
  
  @@index([email])
  @@index([branchId])
  @@map("users")
}

model Branch {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique
  address     String?
  city        String?
  state       String?
  phone       String?
  email       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       User[]
  leads       Lead[]
  admissions  Admission[]
  students    Student[]
  trainers    Trainer[]
  courses     Course[]
  batches     Batch[]
  awards      TrainerAward[]
  trainerAttendances TrainerAttendance[]
  expenses    Expense[]
  socialMedia SocialMediaEngagement[]
  eventPlans  EventPlan[]
  branchReports BranchReport[]
  
  @@map("branches")
}

model Lead {
  id              String     @id @default(uuid())
  firstName       String
  lastName        String
  email           String?
  phone           String
  location        String?
  source          String @default("OTHER")
  status          String @default("NEW")
  interestedCourse String?
  notes           String?
  followUpDate    DateTime?
  
  branchId        String
  createdById     String
  assignedToId    String?
  
  convertedToAdmissionId String?   @unique
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relations
  branch          Branch     @relation(fields: [branchId], references: [id], onDelete: Cascade)
  createdBy       User       @relation("LeadCreator", fields: [createdById], references: [id], onDelete: Cascade)
  assignedTo      User?      @relation("LeadAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)
  admission       Admission? @relation("LeadConversion")
  whatsappLogs    WhatsAppLog[]
  
  @@index([branchId])
  @@index([createdById])
  @@index([assignedToId])
  @@index([status])
  @@map("leads")
}

model Admission {
  id              String          @id @default(uuid())
  admissionNumber String          @unique
  
  firstName       String
  lastName        String
  email           String?
  phone           String
  dateOfBirth     DateTime?
  gender          String?
  address         String?
  
  courseId        String
  batchName       String?
  feeAmount       Float
  feePaid         Float         @default(0)
  feeBalance      Float         @default(0)
  
  status          String @default("PENDING") // PENDING, DROPOUT, etc.
  admissionDate   DateTime        @default(now())
  
  softwareFinishedAt DateTime?    // To trigger conduct exam reminders
  
  branchId        String
  leadId          String?         @unique
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  branch          Branch          @relation(fields: [branchId], references: [id], onDelete: Cascade)
  course          Course          @relation(fields: [courseId], references: [id])
  lead            Lead?           @relation("LeadConversion", fields: [leadId], references: [id])
  student         Student?
  whatsappLogs    WhatsAppLog[]
  
  @@index([branchId])
  @@index([courseId])
  @@index([status])
  @@map("admissions")
}

model Student {
  id              String   @id @default(uuid())
  userId          String   @unique
  admissionId     String   @unique
  enrollmentNumber String  @unique
  
  currentSemester Int?
  cgpa            Float?
  
  branchId        String
  courseId        String
  batchId         String?
  
  isActive        Boolean  @default(true)
  placementEligible Boolean @default(false)
  certificateLocked Boolean @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User     @relation("StudentUser", fields: [userId], references: [id], onDelete: Cascade)
  admission       Admission @relation(fields: [admissionId], references: [id], onDelete: Cascade)
  branch          Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  course          Course   @relation(fields: [courseId], references: [id])
  batch           Batch?   @relation(fields: [batchId], references: [id], onDelete: SetNull)
  
  attendances     Attendance[]
  portfolios      Portfolio[] // Legacy portfolio
  portfolioSubmissions PortfolioSubmission[]
  softwareProgress SoftwareProgress[]
  testScores       TestScore[]
  placements      Placement[]
  growthReports   StudentGrowthReport[]
  feedbacks       StudentFeedback[]
  
  @@index([branchId])
  @@index([courseId])
  @@index([batchId])
  @@map("students")
}

model Trainer {
  id              String   @id @default(uuid())
  userId          String   @unique
  employeeId      String   @unique
  
  specialization  String?
  experience      Int?     // years
  qualification   String?
  
  branchId        String
  
  isActive        Boolean  @default(true)
  joiningDate     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  branch          Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  
  courses           CourseTrainer[]
  batches           Batch[]
  attendances       Attendance[]
  trainerAttendances TrainerAttendance[]
  portfolioSubmissions PortfolioSubmission[]
  incentives        Incentive[]
  growthReports     StudentGrowthReport[]
  fileReports       ClassAndPortfolioReport[]
  awards            TrainerAward[]
  
  @@index([branchId])
  @@map("trainers")
}

model Course {
  id              String   @id @default(uuid())
  name            String
  code            String   @unique
  description     String?
  duration        Int      // in months
  fees            Float
  
  syllabus        String?  // JSON or text
  prerequisites   String?
  
  branchId        String?
  
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  branch          Branch?  @relation(fields: [branchId], references: [id], onDelete: Cascade)
  
  trainers        CourseTrainer[]
  batches         Batch[]
  portfolioTasks  PortfolioTask[]
  admissions      Admission[]
  students        Student[]
  attendances     Attendance[]
  growthReports   StudentGrowthReport[]
  
  @@index([branchId])
  @@map("courses")
}

model CourseTrainer {
  id              String   @id @default(uuid())
  courseId        String
  trainerId       String
  
  assignedAt      DateTime @default(now())
  isActive        Boolean  @default(true)

  // Relations
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  trainer         Trainer  @relation(fields: [trainerId], references: [id], onDelete: Cascade)
  
  @@unique([courseId, trainerId])
  @@index([courseId])
  @@index([trainerId])
  @@map("course_trainers")
}

model Attendance {
  id              String           @id @default(uuid())
  date            DateTime
  status          String           // PRESENT, ABSENT, LATE
  remarks         String?
  
  inTime          DateTime?
  outTime         DateTime?
  latitude        Float?
  longitude       Float?
  period          Int              @default(1)
  isVerified      Boolean          @default(false)
  
  studentId       String
  courseId        String
  batchId         String?
  trainerId       String?
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  student         Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course          Course           @relation(fields: [courseId], references: [id])
  batch           Batch?           @relation(fields: [batchId], references: [id], onDelete: SetNull)
  trainer         Trainer?         @relation(fields: [trainerId], references: [id], onDelete: SetNull)
  
  @@unique([studentId, courseId, date, period])
  @@index([studentId])
  @@index([courseId])
  @@index([batchId])
  @@index([date])
  @@map("attendances")
}

model TrainerAttendance {
  id              String           @id @default(uuid())
  date            DateTime
  status          String           // PRESENT, ABSENT, LATE, HALFDAY
  remarks         String?
  
  inTime          DateTime?
  outTime         DateTime?
  
  trainerId       String
  branchId        String
  
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relations
  trainer         Trainer          @relation(fields: [trainerId], references: [id], onDelete: Cascade)
  branch          Branch           @relation(fields: [branchId], references: [id], onDelete: Cascade)
  
  @@unique([trainerId, date])
  @@index([trainerId])
  @@index([branchId])
  @@index([date])
  @@map("trainer_attendances")
}

model Batch {
  id              String   @id @default(uuid())
  name            String
  code            String   @unique
  
  branchId        String
  courseId        String
  trainerId       String?
  
  startTime       String?  // e.g. "10:00 AM"
  endTime         String?
  
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  branch          Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  course          Course   @relation(fields: [courseId], references: [id])
  trainer         Trainer? @relation(fields: [trainerId], references: [id], onDelete: SetNull)
  students        Student[]
  attendances     Attendance[]
  tests           Test[]
  
  @@index([branchId])
  @@index([courseId])
  @@index([trainerId])
  @@map("batches")
}

model PortfolioTask {
  id              String   @id @default(uuid())
  courseId        String
  title           String
  description     String?
  order           Int      @default(0)
  isMandatory     Boolean  @default(true)
  deadlineDays    Int?     // Number of days after enrollment for deadline
  expectedFormat  String?  // e.g. "PDF", "Link", "ZIP"
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  course          Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  submissions     PortfolioSubmission[]
  
  @@index([courseId])
  @@map("portfolio_tasks")
}

model PortfolioSubmission {
  id              String   @id @default(uuid())
  studentId       String
  taskId          String
  trainerId       String?
  
  workUrl         String?
  behanceUrl      String?
  remarks         String?
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED
  rejectionCount  Int      @default(0)
  
  submittedAt     DateTime @default(now())
  reviewedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  task            PortfolioTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  trainer         Trainer? @relation(fields: [trainerId], references: [id], onDelete: SetNull)
  
  @@index([studentId])
  @@index([taskId])
  @@map("portfolio_submissions")
}


model Test {
  id              String   @id @default(uuid())
  batchId         String
  title           String
  date            DateTime
  totalMarks      Float
  passMarks       Float
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  batch           Batch    @relation(fields: [batchId], references: [id], onDelete: Cascade)
  scores          TestScore[]
  
  @@index([batchId])
  @@map("tests")
}

model TestScore {
  id              String   @id @default(uuid())
  testId          String
  studentId       String
  
  marksObtained   Float
  isPass          Boolean
  remarks         String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  test            Test     @relation(fields: [testId], references: [id], onDelete: Cascade)
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@index([testId])
  @@index([studentId])
  @@unique([testId, studentId])
  @@map("test_scores")
}

model Portfolio {
  id              String   @id @default(uuid())
  studentId       String
  
  title           String
  description     String?
  projectUrl      String?
  githubUrl       String?
  technologies    String? // Array of tech stack
  
  completedAt     DateTime?
  isVerified      Boolean  @default(false)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@index([studentId])
  @@map("portfolios")
}

model Company {
  id              String   @id @default(uuid())
  name            String
  industry        String?
  website         String?
  contactPerson   String?
  contactEmail    String?
  contactPhone    String?
  address         String?
  
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  placements      Placement[]
  
  @@map("companies")
}

model Placement {
  id              String          @id @default(uuid())
  studentId       String
  companyId       String
  
  position        String
  package         Float?
  joiningDate     DateTime?
  
  status          String @default("ELIGIBLE")
  remarks         String?
  
  appliedAt       DateTime        @default(now())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Relations
  student         Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  company         Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  
  @@index([studentId])
  @@index([companyId])
  @@index([status])
  @@map("placements")
}

model SoftwareProgress {
  id              String   @id @default(uuid())
  studentId       String   @unique // One progress record per student for now
  
  completedTopics String   // JSON string or comma-separated list
  currentTopic    String?
  progress        Int      @default(0) // Percentage 0-100
  
  lastUpdated     DateTime @default(now())
  
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  @@map("software_progress")
}

model Incentive {
  id              String        @id @default(uuid())
  type            String
  amount          Float
  description     String?
  
  userId          String
  trainerId       String?
  
  referenceId     String?       // Can link to admission, placement, etc.
  referenceType   String?       // "ADMISSION", "PLACEMENT", etc.
  
  month           Int
  year            Int
  
  isPaid          Boolean       @default(false)
  paidAt          DateTime?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  trainer         Trainer?      @relation(fields: [trainerId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([trainerId])
  @@index([month, year])
  @@map("incentives")
}

model WhatsAppLog {
  id              String   @id @default(uuid())
  to              String
  message         String
  messageType     String   // "text", "template", etc.
  
  leadId          String?
  admissionId     String?
  
  status          String   // "sent", "delivered", "failed"
  errorMessage    String?
  
  sentAt          DateTime @default(now())
  deliveredAt     DateTime?

  // Relations
  lead            Lead?    @relation(fields: [leadId], references: [id], onDelete: SetNull)
  admission       Admission? @relation(fields: [admissionId], references: [id], onDelete: SetNull)
  
  @@index([leadId])
  @@index([admissionId])
  @@index([sentAt])
  @@map("whatsapp_logs")
}

model Notification {
  id              String   @id @default(uuid())
  recipientId     String   // User ID who receives the notification
  title           String
  message         String
  type            String   // "INFO", "WARNING", "SUCCESS", "ERROR"
  link            String?  // Optional link to navigate to
  
  isRead          Boolean  @default(false)
  createdAt       DateTime @default(now())
  
  // Relations
  recipient       User     @relation(fields: [recipientId], references: [id], onDelete: Cascade)
  
  @@index([recipientId])
  @@index([isRead])
  @@map("notifications")
}

model StudentGrowthReport {
  id                String   @id @default(uuid())
  qualityTeaching   Int      // Score 1-10
  doubtClearance    Int      // Score 1-10
  testScore         Float?
  aiUpdate          String?  // Details about AI/Other updates
  portfolioFollowUp Boolean  @default(false)
  classFollowUp     Boolean  @default(false)
  reportDate        DateTime @default(now())
  
  studentId         String
  trainerId         String
  courseId          String
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  student           Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  trainer           Trainer  @relation(fields: [trainerId], references: [id], onDelete: Cascade)
  course            Course   @relation(fields: [courseId], references: [id])

  @@index([studentId])
  @@index([trainerId])
  @@index([reportDate])
  @@map("student_growth_reports")
}

model ClassAndPortfolioReport {
  id              String   @id @default(uuid())
  title           String
  description     String?
  fileUrl         String?
  reportType      String   // "CLASS", "PORTFOLIO"
  status          String   @default("PENDING") // PENDING, CHECKED, REJECTED
  
  trainerId       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  trainer         Trainer  @relation(fields: [trainerId], references: [id], onDelete: Cascade)

  @@index([trainerId])
  @@map("class_portfolio_reports")
}

model StudentFeedback {
  id              String   @id @default(uuid())
  rating          Int      // 1-5
  testimonial     String?
  googleReviewUrl String?
  
  studentId       String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@map("student_feedbacks")
}

model TrainerAward {
  id              String   @id @default(uuid())
  awardName       String   // e.g., "Best Performer"
  month           Int
  year            Int
  metrics         String?  // JSON string of performance metrics at time of award
  
  trainerId       String
  branchId        String
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  trainer         Trainer  @relation(fields: [trainerId], references: [id], onDelete: Cascade)
  branch          Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@unique([trainerId, month, year, awardName])
  @@index([trainerId])
  @@index([branchId])
  @@map("trainer_awards")
}

model Expense {
  id          String   @id @default(uuid())
  amount      Float
  category    String   // e.g., "MARKETING", "UTILITIES", "SALARY"
  description String?
  date        DateTime @default(now())
  
  branchId    String
  branch      Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([branchId])
  @@index([date])
  @@map("expenses")
}

model SocialMediaEngagement {
  id            String   @id @default(uuid())
  platform      String   // e.g., "INSTAGRAM", "FACEBOOK", "LINKEDIN"
  likes         Int      @default(0)
  shares        Int      @default(0)
  leadsGenerated Int     @default(0)
  date          DateTime @default(now())
  
  branchId      String
  branch        Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([branchId])
  @@index([date])
  @@map("social_media_engagements")
}

model EventPlan {
  id          String   @id @default(uuid())
  type        String   // "IV", "SEMINAR"
  title       String
  description String?
  date        DateTime
  status      String   @default("PLANNED") // PLANNED, COMPLETED, CANCELLED
  
  branchId    String
  branch      Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([branchId])
  @@index([date])
  @@map("event_plans")
}
model BranchReport {
  id          String   @id @default(uuid())
  title       String
  description String?
  fileUrl     String
  type        String   // 'Daily Admission', 'Student Discipline', etc.
  branchId    String
  uploadedById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  branch      Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  uploadedBy  User     @relation(fields: [uploadedById], references: [id])

  @@map("branch_reports")
}
